{% extends 'base.html' %}
{% load static %}

{% block title %}Settings - Beyond the Gallery{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-gear me-2"></i>Account Settings</h1>
                <a href="{% url 'users:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Settings Navigation -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title mb-0">Settings</h2>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#account" class="list-group-item list-group-item-action active" data-bs-toggle="tab">
                        <i class="bi bi-person-circle me-2"></i>Account
                    </a>
                    <a href="#profile" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-card-text me-2"></i>Profile
                    </a>
                    <a href="#privacy" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-shield-lock me-2"></i>Privacy
                    </a>
                    <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-bell me-2"></i>Notifications
                    </a>
                    <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-key me-2"></i>Security
                    </a>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="col-lg-9">
            <div class="tab-content">
                <!-- Account Tab -->
                <div class="tab-pane fade show active" id="account">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Account Information</h3>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{% url 'users:settings' %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="username" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="username" name="username" 
                                               value="{{ user.username }}" required>
                                        <div class="form-text">This is how other users will see you on the platform.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email Address</label>
                                        <input type="email" class="form-control" id="email" name="email" 
                                               value="{{ user.email }}" required>
                                        {% if not user.is_email_verified %}
                                            <div class="form-text text-warning">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Email not verified. 
                                                <a href="{% url 'users:resend_verification' %}" class="text-warning">Resend verification</a>
                                            </div>
                                        {% else %}
                                            <div class="form-text text-success">
                                                <i class="bi bi-check-circle me-1"></i>Email verified
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="first_name" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="first_name" name="first_name" 
                                               value="{{ user.first_name }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="last_name" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="last_name" name="last_name" 
                                               value="{{ user.last_name }}">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="device_type" class="form-label">Primary Device</label>
                                        <select class="form-select" id="device_type" name="device_type">
                                            <option value="">Select Device</option>
                                            <option value="iphone" {% if user.device_type == 'iphone' %}selected{% endif %}>iPhone</option>
                                            <option value="ipad" {% if user.device_type == 'ipad' %}selected{% endif %}>iPad</option>
                                            <option value="mac" {% if user.device_type == 'mac' %}selected{% endif %}>Mac</option>
                                            <option value="apple_watch" {% if user.device_type == 'apple_watch' %}selected{% endif %}>Apple Watch</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ios_version" class="form-label">iOS Version</label>
                                        <input type="text" class="form-control" id="ios_version" name="ios_version" 
                                               value="{{ user.ios_version }}" placeholder="e.g., 17.1">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-1"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-pane fade" id="profile">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Profile Information</h3>
                        </div>
                        <div class="card-body">
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="avatar" class="form-label">Profile Picture</label>
                                    <div class="d-flex align-items-center mb-2">
                                        {% if user.profile.avatar %}
                                            <img src="{{ user.profile.avatar.url }}" alt="Current avatar" 
                                                 class="rounded-circle me-3" style="width: 64px; height: 64px; object-fit: cover;">
                                        {% else %}
                                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                 style="width: 64px; height: 64px;">
                                                <i class="bi bi-person-fill text-white"></i>
                                            </div>
                                        {% endif %}
                                        <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
                                    </div>
                                    <div class="form-text">Upload a square image for best results. Max size: 5MB.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="bio" class="form-label">Bio</label>
                                    <textarea class="form-control" id="bio" name="bio" rows="4" 
                                              placeholder="Tell us about yourself...">{{ user.profile.bio }}</textarea>
                                    <div class="form-text">Maximum 500 characters.</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="location" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="location" name="location" 
                                               value="{{ user.profile.location }}" placeholder="City, Country">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="website" class="form-label">Website</label>
                                        <input type="url" class="form-control" id="website" name="website" 
                                               value="{{ user.profile.website }}" placeholder="https://example.com">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="github_username" class="form-label">GitHub Username</label>
                                        <input type="text" class="form-control" id="github_username" name="github_username" 
                                               value="{{ user.profile.github_username }}" placeholder="username">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="twitter_handle" class="form-label">Twitter Handle</label>
                                        <input type="text" class="form-control" id="twitter_handle" name="twitter_handle" 
                                               value="{{ user.profile.twitter_handle }}" placeholder="@username">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-1"></i>Update Profile
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Privacy Tab -->
                <div class="tab-pane fade" id="privacy">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Privacy Settings</h3>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="profile_visibility" class="form-label">Profile Visibility</label>
                                    <select class="form-select" id="profile_visibility" name="profile_visibility">
                                        <option value="public" {% if user.profile.profile_visibility == 'public' %}selected{% endif %}>Public</option>
                                        <option value="private" {% if user.profile.profile_visibility == 'private' %}selected{% endif %}>Private</option>
                                        <option value="friends_only" {% if user.profile.profile_visibility == 'friends_only' %}selected{% endif %}>Friends Only</option>
                                    </select>
                                    <div class="form-text">Controls who can see your profile information.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="email_visibility" class="form-label">Email Visibility</label>
                                    <select class="form-select" id="email_visibility" name="email_visibility">
                                        <option value="private" {% if user.profile.email_visibility == 'private' %}selected{% endif %}>Private</option>
                                        <option value="public" {% if user.profile.email_visibility == 'public' %}selected{% endif %}>Public</option>
                                        <option value="friends_only" {% if user.profile.email_visibility == 'friends_only' %}selected{% endif %}>Friends Only</option>
                                    </select>
                                    <div class="form-text">Controls who can see your email address.</div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="activity_visibility" 
                                               name="activity_visibility" {% if user.profile.activity_visibility %}checked{% endif %}>
                                        <label class="form-check-label" for="activity_visibility">
                                            Show my activity to others
                                        </label>
                                        <div class="form-text">Allow others to see your shortcuts, reviews, and activity.</div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-1"></i>Save Privacy Settings
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div class="tab-pane fade" id="notifications">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Notification Preferences</h3>
                        </div>
                        <div class="card-body">
                            <form method="post">
                                {% csrf_token %}
                                <div class="mb-4">
                                    <h4>Email Notifications</h4>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="email_shortcuts" name="email_shortcuts" checked>
                                        <label class="form-check-label" for="email_shortcuts">
                                            New shortcut reviews and comments
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="email_followers" name="email_followers" checked>
                                        <label class="form-check-label" for="email_followers">
                                            New followers
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="email_updates" name="email_updates" checked>
                                        <label class="form-check-label" for="email_updates">
                                            Platform updates and announcements
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h4>Push Notifications</h4>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="push_shortcuts" name="push_shortcuts" checked>
                                        <label class="form-check-label" for="push_shortcuts">
                                            Shortcut activity
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="push_messages" name="push_messages" checked>
                                        <label class="form-check-label" for="push_messages">
                                            Direct messages
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-1"></i>Save Notification Settings
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="security">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title mb-0">Security Settings</h3>
                        </div>
                        <div class="card-body">
                            <!-- Two-Factor Authentication Section -->
                            <div class="mb-4">
                                <h4>Two-Factor Authentication</h4>
                                <p class="text-muted mb-3">Add an extra layer of security to your account by enabling two-factor authentication.</p>
                                
                                <!-- 2FA Status Check -->
                                {% if user.two_factor_enabled %}
                                    <div class="alert alert-success d-flex align-items-center" role="alert">
                                        <i class="bi bi-shield-check me-2"></i>
                                        <div>
                                            <strong>Two-Factor Authentication is enabled</strong>
                                            <br>
                                            <small>Your account is protected with an additional security layer.</small>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'users:mfa_status' %}" class="btn btn-outline-primary">
                                            <i class="bi bi-gear me-1"></i>Manage 2FA
                                        </a>
                                        <a href="{% url 'users:2fa_backup_codes' %}" class="btn btn-outline-secondary">
                                            <i class="bi bi-key me-1"></i>Backup Codes
                                        </a>
                                        <a href="{% url 'users:2fa_disable' %}" class="btn btn-outline-danger">
                                            <i class="bi bi-shield-slash me-1"></i>Disable 2FA
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                                        <i class="bi bi-shield-exclamation me-2"></i>
                                        <div>
                                            <strong>Two-Factor Authentication is disabled</strong>
                                            <br>
                                            <small>Enable 2FA to secure your account with authenticator apps like Google Authenticator or Authy.</small>
                                        </div>
                                    </div>
                                    <a href="{% url 'users:2fa_setup' %}" class="btn btn-primary">
                                        <i class="bi bi-shield-plus me-1"></i>Enable Two-Factor Authentication
                                    </a>
                                {% endif %}
                            </div>

                            <hr>

                            <div class="mb-4">
                                <h4>Password</h4>
                                <p class="text-muted mb-3">Keep your account secure with a strong password.</p>
                                <a href="{% url 'users:password_change' %}" class="btn btn-outline-primary">
                                    <i class="bi bi-key me-1"></i>Change Password
                                </a>
                            </div>
                            
                            <div class="mb-4">
                                <h4>Active Sessions</h4>
                                <p class="text-muted mb-3">Monitor your account's active sessions.</p>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Current Session</strong>
                                                <br>
                                                <small class="text-muted">{{ request.META.HTTP_USER_AGENT|truncatechars:50 }}</small>
                                            </div>
                                            <span class="badge bg-success">Active</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h4>Account Actions</h4>
                                <p class="text-muted mb-3">Manage your account data and settings.</p>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#exportModal">
                                        <i class="bi bi-download me-1"></i>Export Data
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                        <i class="bi bi-trash me-1"></i>Delete Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Data Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="exportModalLabel">Export Your Data</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>We'll prepare a download of your data including:</p>
                <ul>
                    <li>Profile information</li>
                    <li>Created shortcuts</li>
                    <li>Reviews and comments</li>
                    <li>Favorites and activity</li>
                </ul>
                <p>You'll receive an email with a download link when your data is ready.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Request Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="deleteModalLabel">Delete Account</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
                <p>Deleting your account will:</p>
                <ul>
                    <li>Permanently remove your profile and data</li>
                    <li>Delete all your shortcuts and reviews</li>
                    <li>Remove you from all followers' lists</li>
                </ul>
                <p>Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete Account</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .tab-content {
        min-height: 500px;
    }
    
    .list-group-item-action.active {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
    
    .card-header {
        background-color: var(--bs-dark);
        border-bottom: 1px solid var(--bs-gray-800);
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }
</style>
{% endblock %}
